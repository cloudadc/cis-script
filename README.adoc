= F5 CIS 101
:toc: manual

== Configmap Hub Mode

[source, bash]
.*1. Install CIS Controller*
----
kubectl create ns bigip-ctlr
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-hub/install/rbac.yaml
kubectl apply -f configmap-hub/install/cis.yaml 
----

[source, bash]
.*2. Deploy App*
----
kubectl apply -f configmap-hub/apps.yaml
----

[source, bash]
.*3. Deploy Configmap*
----
kubectl apply -f configmap-hub/cm.yaml
----

[source, bash]
.*4. Verify deployment via tmsh*
----
~ # tmsh list auth partition | grep cistest | awk '{print $3}'
cistest1
cistest2
cistest5
----

[source, bash]
.*5. #1387 duplicated label verification*
----
kubectl apply -f configmap-hub/duplicated-label.yaml 
----

Check from cis pod log, the following logs

[source, bash]
----
2022/05/16 08:44:11 [WARNING] [CORE] Multiple Services are tagged for this pool. Using oldest service endpoints.
Service: app-svc-1, Namespace: cistest1,Timestamp: 2022-05-16 08:07:30 +0000 UTC

2022/05/16 08:44:12 [WARNING] [CORE] Multiple Services are tagged for this pool. Using oldest service endpoints.
Service: app-svc-1, Namespace: cistest1,Timestamp: 2022-05-16 08:07:30 +0000 UTC
----

[source, bash]
.*6. Tear down*
----
kubectl delete -f configmap-hub/duplicated-label.yaml
kubectl delete -f configmap-hub/cm.yaml
kubectl delete -f configmap-hub/apps.yaml

kubectl delete -f configmap-hub/install/rbac.yaml
kubectl delete -f configmap-hub/install/cis.yaml
kubectl delete -f configmap-hub/install/ns.yaml
----

== 422 response DEBUG

[source, bash]
.*1. Install CIS Controller*
----
kubectl create ns bigip-ctlr
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-422/install/rbac.yaml
kubectl apply -f configmap-422/install/cis.yaml
----

[source, bash]
.*2. Deploy App*
----
kubectl apply -f configmap-422/deploy.yaml
----

[source, bash]
.*3. Deploy Configmap*
----
kubectl apply -f configmap-422/cm.yaml
----

[source, bash]      
.*4. Issue Reproduction*
----
for i in {1..3} ; do echo $i ;kubectl delete -f configmap-422/deploy.yaml ; kubectl apply -f configmap-422/deploy.yaml ; sleep 30 ; echo;  done
----

CIS error log looks:

[source, bash]
----
2022/07/16 16:11:53 [ERROR] [AS3] Big-IP Responded with code: 422
----

The Restnoded log looks

[source, bash]
----
Sat, 16 Jul 2022 16:10:51 GMT - warning: [appsvcs] {"status":422,"message":"declaration is invalid","errors":["/cistest004/app-1/app-1_app_svc_pool/members: pool member /cistest004/app-1/app-1_app_svc_pool/members/0 static address 100.64.21.157 conflicts with bigip node /cistest005/100.64.21.157"],"level":"warning"}

Sat, 16 Jul 2022 16:11:23 GMT - warning: [appsvcs] {"status":422,"message":"declaration is invalid","errors":["/cistest001/app-1/app-1_app_svc_pool/members: pool member /cistest001/app-1/app-1_app_svc_pool/members/0 static address 100.64.23.53 conflicts with bigip node /cistest003/100.64.23.53"],"level":"warning"}
----
