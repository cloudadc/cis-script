= F5 CIS 101
:toc: manual

== 安装

说明：

* livenessProbe 探测 BIG-IP
* 最小化 RBAC（读写分开，读 cluster wide，写 namespace wide）
* 启用hub模式
* 启用基于租户增量更新
* 业务下发验证（1 个 CIS 关联两个 configmap，发布 5 个服务）

[source, bash]
.*1. Install CIS Controller*
----
kubectl apply -f configmap-hub/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-hub/install/rbac-small.yaml
kubectl apply -f configmap-hub/install/cis.yaml 
----

[source, bash]
.*2. Deploy App*
----
kubectl apply -f configmap-hub/apps.yaml
----

[source, bash]
.*3. Deploy Configmap*
----
kubectl apply -f configmap-hub/cm-hub-1.yaml
kubectl apply -f configmap-hub/cm-hub-2.yaml 
----

[source, bash]
.*4. Verify deployment via tmsh*
----
$ ssh root@192.168.200.204 tmsh list auth partition | grep cistest | awk '{print $3}'
Password: 
cistest1
cistest2
cistest3
cistest4
cistest5

$ ssh root@192.168.200.204 'for i in {1..5}; do tmsh list ltm virtual /cistest$i/app-1/app_svc_vs one-line ; done'
Password: 
ltm virtual /cistest1/app-1/app_svc_vs { creation-time 2022-07-19:15:34:07 description app-1 destination /cistest1/10.1.10.1:http ip-protocol tcp last-modified-time 2022-07-19:15:34:07 mask 255.255.255.255 partition cistest1 persist { cookie { default yes } } pool /cistest1/app-1/app-1_app_svc_pool profiles { f5-tcp-progressive { } http { } } serverssl-use-sni disabled source 0.0.0.0/0 source-address-translation { pool /cistest1/app-1/app_svc_vs-self type snat } translate-address enabled translate-port enabled vs-index 2860 }
ltm virtual /cistest2/app-1/app_svc_vs { creation-time 2022-07-19:15:34:10 description app-1 destination /cistest2/10.1.10.2:http ip-protocol tcp last-modified-time 2022-07-19:15:34:10 mask 255.255.255.255 partition cistest2 persist { cookie { default yes } } pool /cistest2/app-1/app-1_app_svc_pool profiles { f5-tcp-progressive { } http { } } serverssl-use-sni disabled source 0.0.0.0/0 source-address-translation { pool /cistest2/app-1/app_svc_vs-self type snat } translate-address enabled translate-port enabled vs-index 2861 }
ltm virtual /cistest3/app-1/app_svc_vs { creation-time 2022-07-19:15:34:33 description app-1 destination /cistest3/10.1.10.3:http ip-protocol tcp last-modified-time 2022-07-19:15:34:33 mask 255.255.255.255 partition cistest3 persist { cookie { default yes } } pool /cistest3/app-1/app-1_app_svc_pool profiles { f5-tcp-progressive { } http { } } serverssl-use-sni disabled service-down-immediate-action reset source 0.0.0.0/0 source-address-translation { pool /cistest3/app-1/app_svc_vs-self type snat } translate-address enabled translate-port enabled vs-index 2863 }
ltm virtual /cistest4/app-1/app_svc_vs { creation-time 2022-07-19:15:34:35 description app-1 destination /cistest4/10.1.10.4:http ip-protocol tcp last-modified-time 2022-07-19:15:34:35 mask 255.255.255.255 partition cistest4 persist { cookie { default yes } } pool /cistest4/app-1/app-1_app_svc_pool profiles { f5-tcp-progressive { } http { } } serverssl-use-sni disabled source 0.0.0.0/0 source-address-translation { pool /cistest4/app-1/app_svc_vs-self type snat } translate-address enabled translate-port enabled vs-index 2864 }
ltm virtual /cistest5/app-1/app_svc_vs { creation-time 2022-07-19:15:34:12 description app-1 destination /cistest5/10.1.10.5:http ip-protocol tcp last-modified-time 2022-07-19:15:34:12 mask 255.255.255.255 partition cistest5 persist { cookie { default yes } } pool /cistest5/app-1/app-1_app_svc_pool profiles { f5-tcp-progressive { } http { } } serverssl-use-sni disabled source 0.0.0.0/0 source-address-translation { pool /cistest5/app-1/app_svc_vs-self type snat } translate-address enabled translate-port enabled vs-index 2862 }
----

[source, bash]
.*5. Tear down*
----
kubectl delete -f configmap-hub/cm-hub-1.yaml
kubectl delete -f configmap-hub/cm-hub-2.yaml
kubectl delete -f configmap-hub/apps.yaml

kubectl delete -f configmap-hub/install/rbac.yaml
kubectl delete -f configmap-hub/install/cis.yaml
kubectl delete -f configmap-hub/install/ns.yaml
----

== 功能测试

=== 会话保持

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 001/app.yaml 
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f 001/cm.yaml 
----

[source, bash]
.*3. 测试验证*
----
$ curl http://192.168.200.31 -v
...
< Set-Cookie: BIGipServer~cistest001~app-1~app_1_svc_pool=2400272484.36895.0000; path=/; Httponly
< 
Server address: 100.64.17.143:8080
Server name: app-1-7f4585dc79-5xkqs
Date: 19/Jul/2022:11:47:36 +0000
URI: /
Request ID: 9d6a255a5216a891e8588b1395ec8bf5

$ curl --cookie "BIGipServer~cistest001~app-1~app_1_svc_pool=2400272484.36895.0000" http://192.168.200.31/test
Server address: 100.64.17.143:8080
Server name: app-1-7f4585dc79-5xkqs
Date: 19/Jul/2022:11:50:26 +0000
URI: /test
Request ID: b92bbb845b76bc4348c1d4a3d3e422eb

$ curl --cookie "BIGipServer~cistest001~app-1~app_1_svc_pool=2400272484.36895.0000" http://192.168.200.31/test/user
Server address: 100.64.17.143:8080
Server name: app-1-7f4585dc79-5xkqs
Date: 19/Jul/2022:11:50:36 +0000
URI: /test/user
Request ID: d4fbc16fea0300ad67263a376a5eab38
----

=== Cookie 加密 

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 002/app.yaml 
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f 002/cm.yaml
----

[source, bash]
.*3. 测试验证*
----
$ curl http://192.168.200.32 -v
...
< Set-Cookie: BIGipServer~cistest002~app-1~app_1_svc_pool=!5agmNHYLuqqe3qfKX3XmY+C0N2Z48JQp+ps7BHHI7cFyhqrRVC/WhN3goMDCQf/nBpJ8+qCR5uT7Slg=; path=/; Httponly
< 
Server address: 100.64.21.180:8080
Server name: app-1-7f4585dc79-n2k6z
Date: 19/Jul/2022:11:59:59 +0000
URI: /
Request ID: c4f8480f1b7ee744c33ccff729f8c99a

$ curl --cookie 'BIGipServer~cistest002~app-1~app_1_svc_pool=!iQ5xKJ7r5J5cx47KX3XmY+C0N2Z48EzgRDLD6LmcMmk5aIzT+IdWNWeMolr/H7KhlzScsmiZMkuQ25o=' http://192.168.200.32/test
Server address: 100.64.21.180:8080
Server name: app-1-7f4585dc79-n2k6z
Date: 19/Jul/2022:12:00:07 +0000
URI: /test
Request ID: 728c77ad635347ec83ef12c993dd54d1

$ curl --cookie 'BIGipServer~cistest002~app-1~app_1_svc_pool=!iQ5xKJ7r5J5cx47KX3XmY+C0N2Z48EzgRDLD6LmcMmk5aIzT+IdWNWeMolr/H7KhlzScsmiZMkuQ25o=' http://192.168.200.32/test/user
Server address: 100.64.21.180:8080
Server name: app-1-7f4585dc79-n2k6z
Date: 19/Jul/2022:12:00:10 +0000
URI: /test/user
Request ID: 6a4cfaec2d62011848adb982415fc388
----

=== 根据请求路径和返回值判断的健康检查

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 003/app.yaml
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f 003/cm.yaml
----

[source, bash]
.*3. 测试验证*
----
$ ssh root@192.168.200.204 tmsh list ltm pool /cistest003/app-1/app_1_svc_pool monitor 
Password: 
ltm pool /cistest003/app-1/app_1_svc_pool {
    monitor min 1 of { /cistest003/app-1/custom_http_monitor }
}
----

=== 多健康检查（TCP + HTTP）

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 004/app.yaml 
----

[source, bash]
.*2. 下发服务（仅 TCP）*
----
kubectl apply -f 004/cm.1.yaml
----

[source, bash]
.*3. 测试验证*
----
$ ssh root@192.168.200.204 tmsh list ltm pool /cistest004/app-1/app_1_svc_pool monitor 
Password: 
ltm pool /cistest004/app-1/app_1_svc_pool {
    monitor min 1 of { tcp }
}
----

[source, bash]
.*4. 下发服务（TCP + HTTP）*
----
kubectl apply -f 004/cm.2.yaml
----

[source, bash]
.*5. 测试验证*
----
$ ssh root@192.168.200.204 tmsh list ltm pool /cistest004/app-1/app_1_svc_pool monitor 
Password: 
ltm pool /cistest004/app-1/app_1_svc_pool {
    monitor min 1 of { tcp /cistest004/app-1/custom_http_monitor }
}
----

=== 使用 Rule 控制流量

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 005/app-1.yaml 
kubectl apply -f 005/app-2.yaml 
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f 005/cm.yaml
----

[source, bash]
.*3. 测试验证*
----
$ ssh root@192.168.200.204 tmsh list ltm rule /cistest005/app-1/iRulesHere
Password: 
ltm rule /cistest005/app-1/iRulesHere {
    partition cistest005
when HTTP_REQUEST {
 if { [HTTP::uri] contains "foo" } {
   pool /cistest005/app-1/app_1_svc_pool
 } elseif {[HTTP::uri] contains "bar"} {
   pool /cistest005/app-2/app_2_svc_pool
 } else {
 pool   /cistest005/app-1/app_1_svc_pool
 }
}
}
----

=== 使用 Policy 控制流量 

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 006/app-1.yaml
kubectl apply -f 006/app-2.yaml
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f 006/cm.yaml
----

[source, bash]
.*3. 测试验证*
----
$ ssh root@192.168.200.204 tmsh list ltm policy /cistest006/app/forward_policy
Password: 
ltm policy /cistest006/app/forward_policy {
    controls { forwarding }
    last-modified 2022-07-19:22:03:04
    partition cistest006
    requires { http }
    rules {
        forward_to_poo1 {
            actions {
                0 {
                    forward
                    select
                    pool /cistest006/app/app_1_svc_pool
                }
            }
            conditions {
                0 {
                    http-uri
                    path
                    contains
                    values { foo }
                }
            }
        }
        forward_to_poo2 {
            actions {
                0 {
                    forward
                    select
                    pool /cistest006/app/app_2_svc_pool
                }
            }
            conditions {
                0 {
                    http-uri
                    path
                    contains
                    values { bar }
                }
            }
            ordinal 1
        }
    }
    status legacy
    strategy best-match
}
----

NOTE: Rule 可以跨 partion, 跨 app，Policy 必需在同一个 app 中。

=== Standard VS，无 HTTP Profile，源地址会话保持

[source, bash]
.*1. 创建应用*
----
kubectl apply -f 007/app.yaml 
----

[source, bash]
.*2. 下发服务*
----
kubectl apply -f cm.yaml 
----

[source, bash]
.*3. 测试验证*
----
$ for i in {1..5} ; do curl -s http://192.168.200.37 | grep address | awk '{print $3}' ; done
100.64.21.158:8080
100.64.21.158:8080
100.64.21.158:8080
100.64.21.158:8080
100.64.21.158:8080
----

=== Standard VS，无 HTTP Profile，源地址会话保持，启用连接镜像

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----

[source, bash]
.*1. 创建应用*
----

----

[source, bash]
.*2. 下发服务*
----

----

[source, bash]
.*3. 测试验证*
----

----


== Configmap Hub Mode Debug

[source, bash]
.*1. Install CIS Controller*
----
kubectl apply -f configmap-debug/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-debug/install/rbac.yaml
kubectl apply -f configmap-debug/install/cis.yaml
----

== Configmap Hub Mode Per Tenants Update

[source, bash]
.*1. Install CIS Controller*
----
kubectl apply -f configmap-filter-tenants/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-filter-tenants/install/rbac.yaml
kubectl apply -f configmap-filter-tenants/install/cis.yaml
----

[source, bash]
.*2. Use the following script to test CIS control plane performance*
----
kubectl apply -f configmap-filter-tenants/deploy-10.yaml 
kubectl apply -f configmap-filter-tenants/cm-10.yaml 
----

[source, bash]
.*3. Delete 1 service's pods 10 times*
----
ns=cistest010 ; for j in {1..10} ; do for i in $(kubectl get pods -n $ns --no-headers | awk '{print $1}') ; do kubectl delete pod  $i -n $ns ; done ; done
----

[source, bash]
.*4. Delete and create all 30 services 3 times*
----
for i in {1..3} ; do  kubectl delete -f configmap-debug/deploy.yaml ; kubectl apply -f configmap-debug/deploy.yaml  ; echo;  done ; 
----

[source, bash]
.*5. Clean up*
----
kubectl delete -f configmap-debug/cm.yaml
kubectl delete -f configmap-debug/deploy.yaml 
kubectl delete -f configmap-debug/install/cis.yaml 
kubectl delete -f configmap-debug/install/rbac.yaml 
kubectl delete -f configmap-debug/install/ns.yaml
----

== Installation - Limited CIS RBAC

[source, bash]
.*1. Install CIS Controller*
----
kubectl apply -f configmap-limited-rbac/install/ns.yaml 
kubectl create secret generic bigip-login --from-literal=username=admin --from-literal=password=admin -n bigip-ctlr
kubectl apply -f configmap-limited-rbac/install/rbac-small.yaml
kubectl apply -f configmap-limited-rbac/install/cis.yaml
----

[source, bash]
.*2. Clean up*
----
kubectl delete -f configmap-debug/install/cis.yaml
kubectl delete -f configmap-debug/install/rbac.yaml
kubectl delete -f configmap-debug/install/ns.yaml
----

== Installation - Limited BIG-IP User Account

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-limited-bigip-account/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-limited-bigip-account/install/rbac.yaml
kubectl apply -f configmap-limited-bigip-account/install/cis.yaml
----

[source, bash]
.*2. Deploy App*
----
kubectl apply -f configmap-limited-bigip-account/deploy.yaml 
kubectl apply -f configmap-limited-bigip-account/cm.yaml 
----

[source, bash]
.*3. Create a customized BIG-IP User*
----
create auth user cis_user password default partition-access add { all-partitions { role admin } } 
----

NOTE: The admin role is necessary for CIS to work.

== Configmap Isolation with L4/l7 Application ADC

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-advanced-adc/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-advanced-adc/install/rbac.yaml
kubectl apply -f configmap-advanced-adc/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f configmap-advanced-adc/cafe.yaml 
kubectl apply -f configmap-advanced-adc/ttcp.yaml 
----

[source, bash]
.*3. Deliver APP*
----
kubectl apply -f configmap-advanced-adc/cm-cafe.yaml 
kubectl apply -f configmap-advanced-adc/cm-ttcp.yaml 
----

The L7 ADC will demostrate:

* Cookie persistence with insert method
* Cookie encription with random cipher text
* Service down immediate action with drop
* Health monitor with path and response pattern mapping
* XFF via iRule
* Least connections member load balancer algorithm
* Customized snat address
* Customized TCP attributes

The L4 ADC will demostrate:

* Source address persistence
* Customized snat address
* Enabled Connection mirroring
* TCP half open health monitoring
* Least connections member load balancer algorithm

== Configmap Management isolation

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-management-isolation/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-management-isolation/install/rbac.yaml
kubectl apply -f configmap-management-isolation/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f configmap-management-isolation/deploy.yaml 
----

[source, bash]
.*3. Deliver APP 1(this will failed due to configmap syntax err)*
----
kubectl apply -f configmap-management-isolation/cm-cistest001.yaml 
----

Check from the cis log, the following errors show up:

[source, bash]
----
2022/06/06 09:19:42 [ERROR] [AS3] Big-IP Responded with error code: 422
----

[source, bash]
.*4. Deliver APP 2*
----
kubectl apply -f configmap-management-isolation/cm-cistest002.yaml 
----

Check from BIG-IP VE, the test002 be delivered successfully even the app 1 delivered failed.

[source, bash]
----
[root@bigip1:Active:Standalone] config # tmsh list ltm virtual /cistest002/app-svc-1-app/app-svc-1-app-vs 
ltm virtual /cistest002/app-svc-1-app/app-svc-1-app-vs {
    creation-time 2022-06-06:16:57:13
    description app-svc-1-app
    destination /cistest002/10.10.10.2:http
    ip-protocol tcp
    last-modified-time 2022-06-06:16:57:13
    mask 255.255.255.255
    partition cistest002
    persist {
        cookie {
            default yes
        }
    }
    pool /cistest002/app-svc-1-app/app-svc-1-app-pool
    profiles {
        f5-tcp-progressive { }
        http { }
    }
    serverssl-use-sni disabled
    source 0.0.0.0/0
    source-address-translation {
        pool /cistest002/app-svc-1-app/app-svc-1-app-vs-self
        type snat
    }
    translate-address enabled
    translate-port enabled
    vs-index 1947
}
----

== Configmap Canary  

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-canary/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-canary/install/rbac.yaml
kubectl apply -f configmap-canary/install/cis.yaml
----

[source, bash]
.*2. Deploy APP(Deploy 2 version of app, 1.0 version on test001, 1.1 version on test002)*
----
kubectl apply -f configmap-canary/backend-canary.yaml
----

[cols="2,5a"]
|===
|Methods |Steps

|URL
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-url.yaml
----

Test

----
curl 192.168.200.13/foo
----

|URL Parameter
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-parametes.yaml
----

Test

----
curl 192.168.200.13/foo?name=1010
----

|Source Address
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-sourceaddr.yaml 
----

Test

----
curl 192.168.200.13/foo
----

|Http Header
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-headers.yaml
----

Test

----
curl 192.168.200.13/foo --header "Canary: true"
----

|Cookie
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-cookie.yaml 
----

Test

----
curl 192.168.200.13/foo --cookie "Canary=true"
----

|Ratio
|Deliver

----
kubectl apply -f configmap-canary/cm-canary-v1.yaml 
kubectl apply -f configmap-canary/cm-canary-v2.yaml
kubectl apply -f configmap-canary/cm-canary-ratio.yaml 
----

Test

----
curl 192.168.200.13/foo 
----

|===

== Configmap Arcadia 

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-arcadia/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-arcadia/install/rbac.yaml
kubectl apply -f configmap-arcadia/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f configmap-arcadia/arcadia.yaml
----

[source, bash]
.*3. Deliver APP*
----
kubectl apply -f configmap-arcadia/cm-v1.yaml
kubectl apply -f configmap-arcadia/cm.yaml
----

Routing Rules

[source, bash]
----
when HTTP_REQUEST {
  if { [HTTP::uri] starts_with "/api" } {
    pool /arcadia/api/api-svc-pool
  } elseif { [HTTP::uri] starts_with "/files" } {
    pool /arcadia/backend/backend-svc-pool
  } elseif { [HTTP::uri] starts_with "/app3" } {
    pool /arcadia/refer/refer-svc-pool
  } else {
    pool /arcadia/main/main-svc-pool
  }
}
----

== Configmap Arcadia Across Namespace Routing

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-arcadia/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-arcadia/install/rbac.yaml
kubectl apply -f configmap-arcadia/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f configmap-arcadia/arcadia-backend.yaml 
kubectl apply -f configmap-arcadia/arcadia-api.yaml 
kubectl apply -f configmap-arcadia/arcadia-refer.yaml 
kubectl apply -f configmap-arcadia/arcadia-main.yaml 
----

[source, bash]
.*3. Deliver APP*
----
kubectl apply -f configmap-arcadia/cm-backend.yaml
kubectl apply -f configmap-arcadia/cm-api.yaml
kubectl apply -f configmap-arcadia/cm-refer.yaml
kubectl apply -f configmap-arcadia/cm-main.yaml 
----

Routing Rules

[source, bash]
----
when HTTP_REQUEST {
  if { [HTTP::uri] starts_with "/api" } {
    pool /arcadia-api/api/api-svc-pool
  } elseif { [HTTP::uri] starts_with "/files" } {
    pool /arcadia-backend/backend/backend-svc-pool
  } elseif { [HTTP::uri] starts_with "/app3" } {
    pool /arcadia-refer/refer/refer-svc-pool
  } else {
    pool /arcadia-main/main/main-svc-pool
  }
}  
----

== Configmap Path Based Route

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-routing/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-routing/install/rbac.yaml
kubectl apply -f configmap-routing/install/cis.yaml
----

[source, bash]
.*3. Deploy APP*
----
kubectl apply -f deploy.yaml
----

[source, bash]
.*3. Depliver APP*
----
kubectl apply -f configmap-routing/cm.yaml
----

== Configmap FastL4 Vs Standard

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-fastl4-standard/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-fastl4-standard/install/rbac.yaml
kubectl apply -f configmap-fastl4-standard/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f  configmap-fastl4-standard/deploy.yaml 
----

[source, bash]
.*3. Deliver APP*
----
kubectl apply -f configmap-fastl4-standard/cm-l4.yaml
kubectl apply -f configmap-fastl4-standard/cm-http.yaml
----

== Configmap AS3 Performance

[source, bash]
.*1. Install*
----
kubectl apply -f configmap-as3/install/ns.yaml
kubectl create secret generic bigip-login --from-literal=username=cis_user --from-literal=password=default -n bigip-ctlr
kubectl apply -f configmap-as3/install/rbac.yaml
kubectl apply -f configmap-as3/install/cis.yaml
----

[source, bash]
.*2. Deploy APP*
----
kubectl apply -f  configmap-as3/deploy.yaml
----

[source, bash]
.**
----

----
